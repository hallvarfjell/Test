<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>LT2 Intervall – PI-kontroller</title>
<style>
  body { font-family: sans-serif; max-width: 900px; margin: auto; }
  canvas { border: 1px solid #ccc; }
  input { width: 80px; }
</style>
</head>
<body>

<h2>LT2 Intervall – Live styring</h2>

<label>Fart (km/t):
<input id="speed" type="number" step="0.1" value="12.0"></label>

<label>Stigning (%):
<input id="incline" type="number" step="0.5" value="5"></label>

<hr>

<p>
Puls: <span id="hr">–</span> bpm<br>
Pulsdriftandel: <span id="drift">–</span> %<br>
<b>PI:</b> <span id="pi">–</span>
</p>

<canvas id="chart" width="850" height="300"></canvas>

<script>
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

const hrMax = 190;
const hrRest = 50;
const PI_LT2 = 55; // historisk LT2-verdi

let time = 0;
let hrBase = 148;
let driftFactor = 0;

let data = [];

function vo2(speed, incline) {
  const v = speed * 1000 / 60;
  return (0.2*v) + (0.9*v*(incline/100)) + 3.5;
}

function drawGraph() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const maxTime = 600; // 10 min
  const slice = data.slice(-maxTime);

  function plot(fn, color, scaleY) {
    ctx.beginPath();
    ctx.strokeStyle = color;
    slice.forEach((d,i)=>{
      const x = i/maxTime * canvas.width;
      const y = canvas.height - fn(d)/scaleY*canvas.height;
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  plot(d=>d.hr, "red", 200);              // total puls
  plot(d=>d.hrDrift, "orange", 200);      // driftandel
  plot(d=>d.speed*10, "blue", 200);       // fart (skalert)
}

setInterval(()=> {
  time++;

  const speed = Number(document.getElementById("speed").value);
  const incline = Number(document.getElementById("incline").value);

  driftFactor += 0.0005;
  const hrDrift = hrBase * driftFactor;
  const hr = hrBase + hrDrift + Math.random()*0.5;

  const hrNorm = (hr - hrRest)/(hrMax - hrRest);
  const PI = vo2(speed, incline)/(hrNorm*(1+driftFactor));

  document.getElementById("hr").textContent = Math.round(hr);
  document.getElementById("drift").textContent = (driftFactor*100).toFixed(1);
  document.getElementById("pi").textContent = PI.toFixed(1);

  data.push({hr, hrDrift, speed});

  if (data.length > 600) data.shift();

  drawGraph();

  // Enkel adaptiv fart (mål: PI_LT2)
  const error = (PI - PI_LT2)/PI_LT2;
  if (Math.abs(error) > 0.03) {
    document.getElementById("speed").value =
      (speed + error*0.5).toFixed(2);
  }

}, 1000);
</script>

</body>
</html>

