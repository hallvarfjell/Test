
import { Store } from './store.js';
export const hrState = { connected:false, hr:null };
export const ftmsState = { connected:false, speedKmh:0, inclinePct:0 };
export async function connectHR(){ try{ const device=await navigator.bluetooth.requestDevice({ filters:[{ services:['heart_rate'] }]}); const server=await device.gatt.connect(); const s=await server.getPrimaryService('heart_rate'); const c=await s.getCharacteristic('heart_rate_measurement'); await c.startNotifications(); c.addEventListener('characteristicvaluechanged', ev=>{ const dv=ev.target.value; const flags=dv.getUint8(0); const hr16=flags & 0x1; const hr= hr16? dv.getUint16(1,true): dv.getUint8(1); hrState.connected=true; hrState.hr=hr; }); } catch(e){ alert('Klarte ikke å koble pulsbelte: '+e); } }
export async function connectFTMS(){ try{ const device=await navigator.bluetooth.requestDevice({ filters:[{ services:[0x1826]}], optionalServices:[0x1826]}); const server=await device.gatt.connect(); const s=await server.getPrimaryService(0x1826); const ch=await s.getCharacteristic(0x2ACD).catch(()=>null); if(ch){ await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', ev=>{ const dv=ev.target.value; const sp= dv.getUint16(2,true)/100; const inc = dv.getInt16(4,true)/100; ftmsState.connected=true; ftmsState.speedKmh=Math.round(sp*3.6); if(!Store.data.settings.treadmill.forceManualIncline) ftmsState.inclinePct=Math.round(inc); }); Store.data.settings.treadmill.supportsFTMS=true; Store.save(); } else { alert('Fant ikke FTMS-data. Manuell kontroll.'); } } catch(e){ alert('Klarte ikke å koble mølle: '+e); } }
