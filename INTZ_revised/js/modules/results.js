
import { Store } from '../store.js';
import { fmtTime } from '../helpers.js';
export function renderResults(){ const host=document.getElementById('app'); const last=Store.data.sessions[Store.data.sessions.length-1]; if(!last){ host.innerHTML='<section class="panel"><h3>Resultater</h3><p>Ingen økter enda.</p></section>'; return;} host.innerHTML=`<section class='panel'><h3>Resultat: ${last.workoutName}</h3><div class='flex' style='gap:1rem;flex-wrap:wrap'><div class='badge'>Varighet: ${fmtTime(last.summary?.durationSec||0)}</div><div class='badge'>Snittpuls: ${last.summary?.avgHr||'—'} bpm</div></div><div style='margin-top:1rem'><table class='table'><thead><tr><th>#</th><th>Fase</th><th>Varighet</th><th>Intensitet</th><th>Mål</th><th>Avg HR</th><th>Avg fart</th><th>RPE</th><th>Merknad</th></tr></thead><tbody>${(last.drags||[]).map((d,i)=>`<tr><td>${i+1}</td><td>${d.phase}</td><td>${fmtTime(d.durationSec||0)}</td><td>${d.intensity||''}</td><td>${d.target? (d.target.speed||'-')+' km/t, '+(d.target.incline||'-')+'%':''}</td><td>${d.avgHr||'—'}</td><td>${d.avgSpeed? d.avgSpeed.toFixed(1):'—'}</td><td>${d.rpe||''}</td><td>${(d.note||'')}</td></tr>`).join('')}</tbody></table></div><div class='footer-actions'><button class='btn' id='btnExportTCX'>Eksporter TCX</button></div></section>`; document.getElementById('btnExportTCX').onclick=()=>{ const tcx=buildTCX(last); const blob=new Blob([tcx],{type:'application/vnd.garmin.tcx+xml'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`INTZ_${(new Date(last.startedAt)).toISOString().replace(/[:.]/g,'-')}.tcx`; a.click(); }; }
function buildTCX(session){ const start=new Date(session.startedAt).toISOString(); const total=session.summary?.durationSec||0; return `<?xml version='1.0' encoding='UTF-8'?>
`+`<TrainingCenterDatabase xmlns='http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2' xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance' xsi:schemaLocation='http://www.garmin.com/xmlschemas/TrainingCenterDatabase/v2 http://www.garmin.com/xmlschemas/TrainingCenterDatabasev2.xsd'>
`+`<Activities><Activity Sport='Running'><Id>${start}</Id><Lap StartTime='${start}'><TotalTimeSeconds>${total}</TotalTimeSeconds><TriggerMethod>Manual</TriggerMethod><Track>`+`${session.drags.map((d,i)=>`<Trackpoint><Time>${new Date(new Date(session.startedAt).getTime()+1000*session.drags.slice(0,i).reduce((a,b)=>a+(b.durationSec||0),0)).toISOString()}</Time>${d.avgHr?`<HeartRateBpm><Value>${d.avgHr}</Value></HeartRateBpm>`:''}<Extensions><LX xmlns='http://www.garmin.com/xmlschemas/ActivityExtension/v2'><AvgSpeed>${(d.avgSpeed||0)/3.6}</AvgSpeed></LX></Extensions></Trackpoint>`).join('')}`+`</Track></Lap><Notes>${session.notes||''}</Notes></Activity></Activities></TrainingCenterDatabase>`; }
