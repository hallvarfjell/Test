const BT = {
  async connectHR(onBPM){ if(!navigator.bluetooth) throw new Error('Web Bluetooth ikke støttet. Bruk Chrome/Edge.'); const device = await navigator.bluetooth.requestDevice({filters:[{services:['heart_rate']} ]}); const server = await device.gatt.connect(); const svc = await server.getPrimaryService('heart_rate'); const ch = await svc.getCharacteristic('heart_rate_measurement'); await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', ev=>{ const dv = ev.target.value; const flags = dv.getUint8(0); let bpm; if(flags & 0x01) bpm = dv.getUint16(1,true); else bpm = dv.getUint8(1); onBPM(bpm); }); },
  async connectFTMS(onData){ if(!navigator.bluetooth) throw new Error('Web Bluetooth ikke støttet.'); const device = await navigator.bluetooth.requestDevice({ filters:[{services:[0x1826]}], optionalServices:[0x180A,0x2ACD,0x2ACC] }); const server = await device.gatt.connect(); device.addEventListener('gattserverdisconnected', ()=>{ console.warn('FTMS frakoblet'); }); let svc; try{ svc = await server.getPrimaryService(0x1826); } catch(e){ if(!device.gatt.connected){ await device.gatt.connect(); svc = await device.gatt.getPrimaryService(0x1826);} else throw e; } const tread = await svc.getCharacteristic(0x2ACD); await tread.startNotifications(); tread.addEventListener('characteristicvaluechanged', ev=>{ const dv = ev.target.value; let idx=0; const flags = dv.getUint16(idx,true); idx+=2; let spd=0, inc=0; let hasSpd = (flags & 0x0001)!==0; let hasInc = (flags & 0x0002)!==0; if(hasSpd){ spd = dv.getUint16(idx,true)/100; idx+=2; } if(hasInc){ inc = dv.getInt16(idx,true)/10; idx+=2; } const kmh = hasSpd ? Math.round(spd*3.6*10)/10 : null; const incOut = hasInc ? Math.round(inc) : null; onData(kmh, incOut); }); }
};
