
import { Store } from '../store.js';
import { $, fmtTime, avg, clamp, requestWakeLock, releaseWakeLock } from '../helpers.js';
import { hrState, ftmsState } from '../ble.js';
export function renderWorkout(){ const w=Store.data.workouts[0]; const seq=expand(w.blocks||[]); const session={ id:crypto.randomUUID(), startedAt:new Date().toISOString(), workoutId:w.id, workoutName:w.name, drags:[], notes:'', settings:JSON.parse(JSON.stringify(Store.data.settings))}; let idx=0, remaining=seq[0]?seq[0].durationSec:0, running=false, timer=null, total=0; let curH=[], curS=[]; document.getElementById('app').innerHTML=`<section class='page-workout'><div class='left-col'><div class='panel'><h3>Ytelse</h3><div class='stack'><div class='value' id='valHR'>--</div><div class='sub'>% av max: <span id='pctHR'>–</span></div></div><div class='stack' style='margin-top:.5rem'><div><div class='label'>Fart (km/t)</div><div class='flex'><button class='btn' id='spdDown'>−</button><div class='value' id='valSpeed'>0</div><button class='btn' id='spdUp'>+</button></div></div><div><div class='label'>Stigning (%)</div><div class='flex'><button class='btn' id='incDown'>−</button><div class='value' id='valIncline'>0</div><button class='btn' id='incUp'>+</button></div></div><div><div class='label'>PI</div><div class='flex'><a class='value' href='#/simulator' id='valPI'>—</a></div></div></div></div><div class='panel zone-bg'><h3>Graf (15 min)</h3><canvas id='chart' class='chart'></canvas><div class='flex' style='margin-top:.25rem; gap:1rem'><span class='badge'>LT1: <span id='lt1'>${Store.data.settings.lt1}</span> bpm</span><span class='badge'>LT2: <span id='lt2'>${Store.data.settings.lt2}</span> bpm</span><span class='badge'>Slope (30s): <span id='slope'>—</span> bpm/s</span></div></div></div><div class='right-col'><div class='panel'><h3>Økt</h3><div class='label'>Fase / Drag / Sett</div><div id='fase' class='value'>—</div><div class='label' style='margin-top:.5rem'>Intensitet</div><div id='intensitet'>—</div><div class='label' style='margin-top:.5rem'>Gjenstående tid</div><div class='value' id='rem'>00:00</div><div class='label' style='margin-top:.5rem'>RPE (1–10) og merknader (lagres ved avsluttet drag)</div><div class='flex'><input id='rpe' type='number' min='1' max='10' class='input' style='width:6ch'/><input id='note' class='input' placeholder='Merknad for siste drag' style='flex:1'/></div><div class='controls' style='margin-top:.5rem'><button class='btn' id='btnAddDrag'>+ Drag</button><button class='btn' id='btnSubDrag'>− Drag</button><button class='btn' id='btnSkip'>Skip drag</button></div></div><div class='panel'><h3>Statistikk</h3><div class='flex' style='gap:1rem'><div><div class='label'>Tid totalt</div><div id='tot'>00:00</div></div><div><div class='label'>Snittpuls (drag)</div><div id='avgDrag'>—</div></div><div><div class='label'>Gjenstående økt</div><div id='leftTot'>—</div></div></div><div class='footer-actions' style='margin-top:1rem'><button class='btn primary' id='btnStartPause'>Start</button><button class='btn danger' id='btnStop'>Stopp & lagre</button></div><div id='iosWarn' class='alert' style='display:none;margin-top:1rem'>Web Bluetooth er ikke støttet på denne enheten/nettleseren. Manuell kontroll vil fungere.</div></div></div></section>`; let speed=0, incline=0; const hrSamples=[], spdSamples=[]; function draw(){ const c=document.getElementById('chart'); const ctx=c.getContext('2d'); const W=c.width=c.clientWidth, H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); const now=performance.now(), win=900000, minT=now-win; const A=hrSamples.filter(p=>p.t>=minT), B=spdSamples.filter(p=>p.t>=minT); const minA=Math.min(...A.map(p=>p.v).concat([60])), maxA=Math.max(...A.map(p=>p.v).concat([180])); const minB=Math.min(...B.map(p=>p.v).concat([0])), maxB=Math.max(...B.map(p=>p.v).concat([25])); ctx.strokeStyle='#325'; ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,H-20); ctx.lineTo(W-10,H-20); ctx.stroke(); ctx.fillStyle='#9fb3c8'; ctx.font='12px system-ui'; ctx.fillText('Puls',5,20); ctx.fillText('Fart',W-46,20); const x=t=>40+((t-minT)/win)*(W-50); const yA=v=>(H-20)-((v-minA)/(maxA-minA))*(H-30); const yB=v=>(H-20)-((v-minB)/(maxB-minB))*(H-30); ctx.strokeStyle='#203154'; ctx.setLineDash([4,4]); for(let i=0;i<=5;i++){ const y=10+i*(H-30)/5; ctx.beginPath(); ctx.moveTo(40,y); ctx.lineTo(W-10,y); ctx.stroke(); } ctx.setLineDash([]); ctx.strokeStyle='#ff5a5f'; ctx.lineWidth=2; ctx.beginPath(); A.forEach((p,i)=>{ const X=x(p.t), Y=yA(p.v); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke(); ctx.strokeStyle='#ffd400'; ctx.beginPath(); B.forEach((p,i)=>{ const X=x(p.t), Y=yB(p.v); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke(); ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; [Store.data.settings.lt1, Store.data.settings.lt2].forEach(v=>{ const Y=yA(v); ctx.beginPath(); ctx.moveTo(40,Y); ctx.lineTo(W-10,Y); ctx.stroke(); }); }
 function slope30(){ const now=performance.now(), minT=now-30000; const S=hrSamples.filter(p=>p.t>=minT); if(S.length<2) return null; const dy=S[S.length-1].v - S[0].v; const dt=(S[S.length-1].t - S[0].t)/1000; return dy/dt; }
 function computePI(){ const like=Store.data.sessions.filter(s=>s.workoutId===session.workoutId).slice(-3); const cur=avg(session.drags.filter(d=>d.phase==='arbeid').map(d=>d.avgHr||0)); const prev=avg(like.map(s=> avg(s.drags.filter(d=>d.phase==='arbeid').map(d=>d.avgHr||0)))); if(!isFinite(cur)||!isFinite(prev)||prev===0) return null; return (prev-cur); }
 function onPhase(){ const cur=seq[idx]; if(!cur) return; if(cur.phase==='pause'||cur.phase==='seriepause') speed=0; else if(cur.target&&typeof cur.target.speed==='number') speed=Math.round(cur.target.speed); if(cur.target&&typeof cur.target.incline==='number') incline=Math.round(cur.target.incline); }
 function update(){ if(hrState.hr!=null) hrSamples.push({t:performance.now(), v:hrState.hr}); spdSamples.push({t:performance.now(), v:speed}); document.getElementById('valHR').textContent=hrState.hr? String(hrState.hr):'--'; const pct=hrState.hr&&Store.data.settings.hrMax? Math.round((hrState.hr/Store.data.settings.hrMax)*100):null; document.getElementById('pctHR').textContent=(pct!=null? pct+'%':'–'); document.getElementById('valSpeed').textContent=Math.round(speed); document.getElementById('valIncline').textContent=Math.round(incline); const cur=seq[idx]; document.getElementById('fase').textContent= cur? `${cur.phase}${cur.rep? ' – Drag '+cur.rep+'/'+cur.reps:''}`:'—'; document.getElementById('intensitet').textContent=cur?(cur.intensity||''):'—'; document.getElementById('rem').textContent=fmtTime(remaining); const left=seq.slice(idx).reduce((a,b)=>a+(b.durationSec||0),0)+remaining-(seq[idx]?.durationSec||0); document.getElementById('leftTot').textContent=fmtTime(left); document.getElementById('avgDrag').textContent=curH.length? Math.round(avg(curH))+' bpm':'—'; const sl=slope30(); document.getElementById('slope').textContent= sl==null? '—': sl.toFixed(2); const pi=computePI(); document.getElementById('valPI').textContent= (pi==null? '—' : (pi>0? '+':'')+pi.toFixed(1)); draw(); }
 function finish(){ const cur=seq[idx]; if(!cur) return; session.drags.push({ phase:cur.phase, durationSec:cur.durationSec, intensity:cur.intensity||'', target:cur.target||{}, avgHr:Math.round(avg(curH))||null, avgSpeed:avg(curS)||null, rpe:+$('#rpe').value||null, note:$('#note').value||''}); $('#rpe').value=''; $('#note').value=''; curH.length=0; curS.length=0; }
 function tick(){ if(!running) return; remaining-=1; total+=1; if(hrState.hr!=null) curH.push(hrState.hr); curS.push(speed); if(remaining<=0){ finish(); idx++; if(idx>=seq.length){ stopAndSave(); return; } remaining=seq[idx].durationSec|0; onPhase(); } update(); }
 function start(){ if(running) return; running=true; document.getElementById('btnStartPause').textContent='Pause'; requestWakeLock(); timer=setInterval(tick,1000); }
 function pause(){ if(!running) return; running=false; document.getElementById('btnStartPause').textContent='Start'; clearInterval(timer); releaseWakeLock(); }
 function stopAndSave(){ pause(); releaseWakeLock(); session.endedAt=new Date().toISOString(); session.summary={ avgHr:Math.round(avg(session.drags.map(d=>d.avgHr||0))||0), durationSec:total }; Store.data.sessions.push(session); Store.save(); location.hash='#/results'; }
 document.getElementById('btnStartPause').onclick=()=> running? pause(): start(); document.getElementById('btnStop').onclick=()=>{ if(running && !confirm('Økt kjører. Avslutte og lagre?')) return; stopAndSave(); }; document.getElementById('btnSkip').onclick=()=>{ finish(); idx++; remaining=seq[idx]? seq[idx].durationSec:0; onPhase(); update(); };
 document.getElementById('spdUp').onclick=()=>{ speed=clamp(Math.round(speed+1),0,25); }; document.getElementById('spdDown').onclick=()=>{ speed=clamp(Math.round(speed-1),0,25); }; document.getElementById('incUp').onclick=()=>{ incline=clamp(Math.round(incline+1),0,15); }; document.getElementById('incDown').onclick=()=>{ incline=clamp(Math.round(incline-1),0,15); };
 window.onkeydown=(e)=>{ if(e.code==='Space'){ e.preventDefault(); running? pause(): start(); } else if(e.key==='s'||e.key==='S'){ stopAndSave(); } else if(e.key==='ArrowUp'){ speed=clamp(Math.round(speed+1),0,25);} else if(e.key==='ArrowDown'){ speed=clamp(Math.round(speed-1),0,25);} else if(e.key==='ArrowRight'){ incline=clamp(Math.round(incline+1),0,15);} else if(e.key==='ArrowLeft'){ incline=clamp(Math.round(incline-1),0,15);} };
 if(ftmsState.connected){ speed=Math.round(ftmsState.speedKmh); if(!Store.data.settings.treadmill.forceManualIncline) incline=Math.round(ftmsState.inclinePct||0); }
 onPhase(); update(); }
function expand(blocks){ const out=[]; const t=(Store.data.settings.transitionPauseSec|0)||0; for(const b of blocks){ if(b.kind==='warmup'||b.kind==='cooldown') out.push({phase:b.kind, durationSec:b.durationSec|0, target:b.target||{}, intensity:b.intensity||''}); else if(b.kind==='set'){ for(let r=1;r<=b.reps;r++){ out.push({phase:'arbeid', durationSec:b.workSec|0, target:b.target||{}, intensity:b.intensity||'', rep:r, reps:b.reps}); out.push({phase:'pause', durationSec:b.restSec|0, target:{speed:0, incline:b.target?.incline||0}, intensity:'Rolig', rep:r, reps:b.reps}); if(r<b.reps && t>0) out.push({phase:'seriepause', durationSec:t, hidden:true}); } } else if(b.kind==='continuous'){ for(const s of (b.segments||[])){ out.push({phase:'kontinuerlig', durationSec:s.durationSec|0, target:s.target||{}, intensity:s.intensity||''}); if(t>0) out.push({phase:'overgang', durationSec:t, hidden:true}); } } } return out; }
